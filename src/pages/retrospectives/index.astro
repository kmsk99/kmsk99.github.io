---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import PostCard from '../../components/PostCard.astro';
import Sidebar from '../../components/Sidebar.astro';
import Pagination from '../../components/Pagination.astro';

const retrospectives = (await getCollection('retrospectives')).sort(
	(a, b) => new Date(b.data.created).getTime() - new Date(a.data.created).getTime(),
);
const pageSize = 20;
const pageCount = Math.max(1, Math.ceil(retrospectives.length / pageSize));
---

<BaseLayout title="회고 목록">
	<div class="layout-grid">
		<Sidebar />

		<div class="main-column">
			<section class="block">
				<header class="block__header">
					<div>
						<p class="eyebrow">Retrospectives</p>
						<h1>회고</h1>
						<p class="lede">프로젝트와 경험에서 배운 점을 정리한 회고 모음</p>
					</div>
				</header>
				<div class="list">
					{retrospectives.map((ret, idx) => {
						const page = Math.floor(idx / pageSize) + 1;
						return (
							<div
								class="paginated-item"
								data-page={page}
								data-category={(ret as any).id.split('/')[0] || 'retrospectives'}
							>
								<PostCard entry={ret as any} />
							</div>
						);
					})}
				</div>
				<Pagination pageCount={pageCount} />
			</section>
		</div>
	</div>

	<script is:inline>
		const initPagination = () => {
			const items = Array.from(document.querySelectorAll('.paginated-item'));
			const buttons = Array.from(document.querySelectorAll('.pagination-btn'));
			const params = new URLSearchParams(window.location.search);
			const initialCategory = params.get('category') || '__all';
			let currentPage = 1;
			let totalPages =
				Math.max(
					1,
					Math.ceil(items.length / Math.max(...items.map((el) => Number(el.dataset.page || '1')))),
				) || 1;

			function applyPage(page) {
				currentPage = Math.max(1, Math.min(page, totalPages));
				items.forEach((el) => {
					const p = Number(el.dataset.page || '1');
					el.style.display = p === currentPage ? '' : 'none';
				});
				buttons.forEach((b) => {
					if (!b.dataset.page || b.dataset.page === 'prev' || b.dataset.page === 'next') return;
					b.classList.toggle('active', Number(b.dataset.page) === currentPage);
				});
			}

			function applyFilter(category) {
				const isFiltered = category && category !== '__all';
				const filtered = [];
				items.forEach((el) => {
					const cat = el.dataset.category || '';
					const match = !isFiltered || cat === category;
					if (match) filtered.push(el);
					el.dataset.match = match ? '1' : '0';
				});
				if (isFiltered) {
					filtered.forEach((el) => (el.style.display = ''));
					items.forEach((el) => {
						if (el.dataset.match === '0') el.style.display = 'none';
					});
					totalPages = 1;
					buttons.forEach((b) => {
						if (!b.dataset.page || b.dataset.page === 'prev' || b.dataset.page === 'next') {
							b.style.display = 'none';
						} else {
							b.style.display = b.dataset.page === '1' ? '' : 'none';
							b.classList.toggle('active', b.dataset.page === '1');
						}
					});
				} else {
					totalPages = Math.max(
						1,
						Math.ceil(items.length / Math.max(...items.map((el) => Number(el.dataset.page || '1')))),
					);
					buttons.forEach((b) => (b.style.display = ''));
					applyPage(1);
				}
			}

			buttons.forEach((btn) => {
				btn.addEventListener('click', () => {
					const val = btn.dataset.page;
					if (val === 'prev') return applyPage(currentPage - 1);
					if (val === 'next') return applyPage(currentPage + 1);
					applyPage(Number(val || '1'));
				});
			});

			applyFilter(initialCategory);
			if (initialCategory === '__all') applyPage(1);
		};

		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', initPagination, { once: true });
		} else {
			initPagination();
		}
	</script>
</BaseLayout>


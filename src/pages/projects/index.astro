---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import PostCard from '../../components/PostCard.astro';
import Sidebar from '../../components/Sidebar.astro';

const projects = (await getCollection('projects')).sort(
	(a, b) => new Date(b.data.created).getTime() - new Date(a.data.created).getTime(),
);

const getProjectCategory = (entry: (typeof projects)[number]) => {
	const id = (entry as any).id || '';
	return id.split('/')[0] || 'project-showcase';
};
---

<BaseLayout title="프로젝트 목록">
	<div class="layout-grid">
		<Sidebar tagType="project" />

		<div class="main-column">
			<section class="block">
				<header class="block__header">
					<div>
						<p class="eyebrow">Projects</p>
						<h1>프로젝트</h1>
						<p class="lede">기획부터 배포·운영까지 흐름을 그대로 담은 프로젝트 모음</p>
					</div>
				</header>
				<div class="list filter-target">
					{projects.map((project) => {
						const tags = project.data.tags?.join(',') ?? '';
						const category = getProjectCategory(project);
						return (
							<div class="list-row" data-category={category} data-tags={tags}>
								<PostCard entry={project as any} />
							</div>
						);
					})}
				</div>
			</section>
		</div>
	</div>

	<script is:inline>
		const initFilters = () => {
			const tagButtons = Array.from(document.querySelectorAll('.tag-pill'));
			const targets = Array.from(document.querySelectorAll('.filter-target > *'));
			const categoryButtons = Array.from(document.querySelectorAll('.tree__btn[data-type="project"]'));
			let currentTag = '__all';
			let currentCategory = '__all';

			const params = new URLSearchParams(window.location.search);
			const urlCategory = params.get('category');
			const urlTag = params.get('tag');
			if (urlCategory) currentCategory = urlCategory;
			if (urlTag) currentTag = urlTag;

			const syncTagButtons = () => {
				tagButtons.forEach((btn) => btn.classList.toggle('active', btn.dataset.tag === currentTag));
			};

			const syncCategoryButtons = () => {
				categoryButtons.forEach((btn) =>
					btn.classList.toggle('active', btn.dataset.category === currentCategory),
				);
			};

			const applyFilters = () => {
				targets.forEach((el) => {
					const elCategory = el.dataset.category;
					const elTags = el.dataset.tags?.split(',').filter(Boolean) ?? [];
					const matchCategory = currentCategory === '__all' || elCategory === currentCategory;
					const matchTag = currentTag === '__all' || elTags.includes(currentTag);
					el.style.display = matchCategory && matchTag ? '' : 'none';
				});
			};

			tagButtons.forEach((btn) => {
				btn.addEventListener('click', () => {
					currentTag = btn.dataset.tag ?? '__all';
					syncTagButtons();
					applyFilters();
				});
			});

			syncTagButtons();
			syncCategoryButtons();
			applyFilters();
		};

		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', initFilters, { once: true });
		} else {
			initFilters();
		}
	</script>
</BaseLayout>


---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import ProjectCard from '../components/ProjectCard.astro';
import PostCard from '../components/PostCard.astro';

const projects = (await getCollection('projects')).sort(
	(a, b) => new Date(b.data.created).getTime() - new Date(a.data.created).getTime(),
);
const posts = (await getCollection('posts')).sort(
	(a, b) => new Date(b.data.created).getTime() - new Date(a.data.created).getTime(),
);
const retrospectives = (await getCollection('retrospectives')).sort(
	(a, b) => new Date(b.data.created).getTime() - new Date(a.data.created).getTime(),
);

const pageSize = 20;

const labelFromFolder = (slug: string) => slug.replace(/-/g, ' ');

const getPostCategory = (entry: (typeof posts)[number]) => {
	const id = (entry as any).id || '';
	const cat = id.split('/')[0] || 'misc';
	return cat;
};

const getRetroCategory = (entry: (typeof retrospectives)[number]) => {
	const id = (entry as any).id || '';
	return id.split('/')[0] || 'retrospectives';
};

const postCategories = posts.reduce<Record<string, { count: number; label: string }>>((acc, p) => {
	const cat = getPostCategory(p);
	if (!acc[cat]) acc[cat] = { count: 0, label: labelFromFolder(cat) };
	acc[cat].count += 1;
	return acc;
}, {});

const getProjectCategory = (entry: (typeof projects)[number]) => {
	const id = (entry as any).id || '';
	return id.split('/')[0] || 'project-showcase';
};

const projectCategories = projects.reduce<Record<string, { count: number; label: string }>>((acc, p) => {
	const cat = getProjectCategory(p);
	if (!acc[cat]) acc[cat] = { count: 0, label: labelFromFolder(cat) };
	acc[cat].count += 1;
	return acc;
}, {});

const projectTree = Object.entries(projectCategories).map(([key, info]) => ({
	folder: info.label,
	title: info.label,
	slug: key,
	count: info.count,
}));

const postTree = Object.entries(postCategories).map(([key, info]) => ({
	folder: info.label,
	title: info.label,
	slug: key,
	count: info.count,
}));

const retroCategories = retrospectives.reduce<Record<string, { count: number; label: string }>>((acc, r) => {
	const cat = getRetroCategory(r);
	if (!acc[cat]) acc[cat] = { count: 0, label: labelFromFolder(cat) };
	acc[cat].count += 1;
	return acc;
}, {});

const retroTree = Object.entries(retroCategories).map(([key, info]) => ({
	folder: info.label,
	title: info.label,
	slug: key,
	count: info.count,
}));

const tags = [...projects, ...posts, ...retrospectives].reduce<Record<string, number>>((acc, item) => {
	(item.data.tags ?? []).forEach((tag) => {
		acc[tag] = (acc[tag] ?? 0) + 1;
	});
	return acc;
}, {});
const sortedTags = Object.entries(tags).sort((a, b) => b[1] - a[1]);

const combined = [
	...projects.map((p) => ({ type: 'project', entry: p, category: getProjectCategory(p) })),
	...posts.map((p) => ({ type: 'post', entry: p, category: getPostCategory(p) })),
	...retrospectives.map((r) => ({ type: 'retro', entry: r, category: getRetroCategory(r) })),
].sort((a, b) => new Date(b.entry.data.created).getTime() - new Date(a.entry.data.created).getTime());

const pageCount = Math.max(1, Math.ceil(combined.length / pageSize));
---

<BaseLayout title="í™ˆ">
	<div class="layout-grid">
		<aside class="sidebar">
			<section class="block compact">
				<p class="eyebrow">Categories</p>
				<ul class="tree">
					<li class="tree__section">Projects ({projects.length})</li>
					{projectTree.map((item) => (
						<li>
							<button class="tree__btn" data-type="project" data-category={item.slug}>
								<span class="tree__folder">ğŸ“</span>
								<span class="tree__title">{item.title}</span>
							</button>
						</li>
					))}
					<li class="tree__section">Posts ({posts.length})</li>
					{postTree.map((item) => (
						<li>
							<button class="tree__btn" data-type="post" data-category={item.slug}>
								<span class="tree__folder">ğŸ“</span>
								<span class="tree__title">
									{item.title} ({item.count})
								</span>
							</button>
						</li>
					))}
					<li class="tree__section">Retrospectives ({retrospectives.length})</li>
					{retroTree.map((item) => (
						<li>
							<button class="tree__btn" data-type="retro" data-category={item.slug}>
								<span class="tree__folder">ğŸ“</span>
								<span class="tree__title">
									{item.title} ({item.count})
								</span>
							</button>
						</li>
					))}
				</ul>
			</section>

			<section class="block compact">
				<p class="eyebrow">Tags</p>
				<div class="tag-list" id="tag-list">
					<button class="tag-pill active" data-tag="__all">
						All ({projects.length + posts.length + retrospectives.length})
					</button>
					{sortedTags.map(([tag, count]) => (
						<button class="tag-pill" data-tag={tag}>
							#{tag} ({count})
						</button>
					))}
				</div>
			</section>
		</aside>

		<div class="main-column">
			<section class="hero">
				<div>
					<p class="eyebrow">Fullstack Developer Â· CTO @ Portzone</p>
					<h1>ê¹€ë¯¼ì„ Â· í¬íŠ¸í´ë¦¬ì˜¤ & ê¸°ìˆ  ë¸”ë¡œê·¸</h1>
					<p class="lede">
						â€œë¬¸ì œë¥¼ ì •í™•íˆ ì •ì˜í•˜ê³ , ì‘ë™í•˜ëŠ” ê²ƒì„ ë¹ ë¥´ê²Œ ë§Œë“¤ê³ , ë§ˆì§€ë§‰ 20%ì—ì„œ í’ˆì§ˆì„ ì§€ì¼œë‚´ëŠ” ê²ƒâ€ì„
						ê°€ì¥ ì¤‘ìš”í•˜ê²Œ ìƒê°í•©ë‹ˆë‹¤. ê¸°íš-í”„ë¡ íŠ¸-ë°±ì—”ë“œ-ë°ì´í„°-í´ë¼ìš°ë“œê¹Œì§€ ì „ ìŠ¤íƒì„ ì¼ê´€ëœ
						ì•„í‚¤í…ì²˜ë¡œ ì—®ì–´ ì œí’ˆì„ ì¶œì‹œí•´ ì™”ìŠµë‹ˆë‹¤.
					</p>
					<ul class="lede" style="list-style: disc; padding-left: 18px; margin: 10px 0 12px;">
						<li>ì§‘ì¤‘ ë¶„ì•¼: AI ì¶”ì²œÂ·ê°•í™”í•™ìŠµ, ëª¨ë˜ í’€ìŠ¤íƒ(Next.js/NestJS), Web3 ì—°ë™</li>
						<li>ì—­í• : í¬íŠ¸ì¡´ CTO, ì„œê°•ëŒ€ ë°ì´í„°ì‚¬ì´ì–¸ìŠ¤Â·AI ì „ê³µ</li>
						<li>ì›ì¹™: ë³´ì•ˆÂ·ìë™í™”Â·ê°€ì‹œì„±ìœ¼ë¡œ ì„œë¹„ìŠ¤ í’ˆì§ˆì„ ë†’ì´ëŠ” ì„¤ê³„</li>
					</ul>
					<div class="lede" style="margin: 10px 0 14px;">
						<p style="margin: 4px 0;"><strong>AI/ë°ì´í„°:</strong> ì¶”ì²œÂ·ë­í‚¹ ëª¨ë¸, ê°•í™”í•™ìŠµ ì‹¤í—˜, OCR+LLM íŒŒì´í”„ë¼ì¸</p>
						<p style="margin: 4px 0;"><strong>FE/ëª¨ë°”ì¼:</strong> Next.js App Router, React Native/Expo, ì„±ëŠ¥Â·DX ìµœì í™”</p>
						<p style="margin: 4px 0;"><strong>BE/ì¸í”„ë¼:</strong> NestJS/GraphQL/Prisma, Supabase/Firebase, AWS/GCP, CI/CD ìë™í™”</p>
						<p style="margin: 4px 0;"><strong>ë³´ì•ˆÂ·ì‹ ë¢°ì„±:</strong> AWS KMSÂ·Web Crypto ì´ì¤‘ ì•”í˜¸í™”, ë‹¤ë‹¨ê³„ ì¸ì¦/ê¶Œí•œ ë¶„ë¦¬, ì¥ì•  ìë™ ë³µêµ¬</p>
						<p style="margin: 4px 0;"><strong>ì„±ê³¼ ì§€í‘œ:</strong> ë°°í¬ ë¦¬ë“œíƒ€ì„ 50% ë‹¨ì¶•, ì¥ì•  ëŒ€ì‘ ì‹œê°„ 50% ë‹¨ì¶•, ë””ìì¸ ì‹œìŠ¤í…œ ì˜¨ë³´ë”© 70% ì ˆê°</p>
						<p style="margin: 4px 0;"><strong>ìš´ì˜ ë¬¸í™”:</strong> GitHub Actions + pnpm ëª¨ë…¸ë ˆí¬, HeadVerÂ·Husky, ESLint/Prettierë¡œ í’ˆì§ˆ ê²Œì´íŠ¸ ì¼ì›í™”</p>
					</div>
					<div class="actions">
						<a class="button primary" href="mailto:kochevnik99@gmail.com">ì´ë©”ì¼</a>
						<a class="button ghost" href="https://linkedin.com/in/kmsk99" target="_blank">LinkedIn</a>
					</div>
				</div>
			</section>

			<section class="block">
				<header class="block__header">
					<div>
						<p class="eyebrow">Feed</p>
						<h2>ìµœê·¼ ê¸€</h2>
					</div>
					<p class="lede">í”„ë¡œì íŠ¸ì™€ í¬ìŠ¤íŠ¸ë¥¼ í•œ ë¦¬ìŠ¤íŠ¸ë¡œ ëª¨ì•˜ìŠµë‹ˆë‹¤.</p>
				</header>
				<div class="list filter-target">
					{combined.map((item, idx) => {
						const page = Math.floor(idx / pageSize) + 1;
						const tags = item.entry.data.tags?.join(',') ?? '';
						return (
							<div
								class="list-row"
								data-type={item.type}
								data-category={item.category}
								data-tags={tags}
								data-page={page}
							>
								{item.type === 'project' ? (
									<ProjectCard entry={item.entry as any} category="project-showcase" />
								) : (
									<PostCard entry={item.entry as any} category={item.category} />
								)}
							</div>
						);
					})}
				</div>
				<div class="pagination">
					<button class="pagination-btn" data-page="prev" aria-label="ì´ì „ í˜ì´ì§€">
						â†
					</button>
					{Array.from({ length: pageCount }).map((_, i) => {
						const page = i + 1;
						return (
							<button class="pagination-btn" data-page={page}>
								{page}
							</button>
						);
					})}
					<button class="pagination-btn" data-page="next" aria-label="ë‹¤ìŒ í˜ì´ì§€">
						â†’
					</button>
				</div>
			</section>
		</div>
	</div>

	<script is:inline>
		const initFilters = () => {
			const tagButtons = Array.from(document.querySelectorAll('.tag-pill'));
			const targets = Array.from(document.querySelectorAll('.filter-target > *'));
			const categoryButtons = Array.from(document.querySelectorAll('.tree__btn'));
			const paginationContainer = document.querySelector('.pagination');
			const paginationButtons = Array.from(document.querySelectorAll('.pagination-btn'));
			const pageNumberButtons = paginationButtons.filter(
				(btn) => btn.dataset.page && btn.dataset.page !== 'prev' && btn.dataset.page !== 'next',
			);
			const pageSize = 20;
			const initialTotalPages = Math.max(
				1,
				Math.ceil(targets.length / pageSize),
			); /* ì„œë²„ ë Œë”ëœ pageCount ëŒ€ì²´ */

			let currentTag = '__all';
			let currentCategory = '__all';
			let currentType = 'all';
			let currentPage = 1;
			let totalPages = initialTotalPages;

			function applyFilters() {
				const matched = [];
				targets.forEach((el) => {
					const elType = el.dataset.type;
					const elCategory = el.dataset.category;
					const elTags = el.dataset.tags?.split(',').filter(Boolean) ?? [];

					const matchType = currentType === 'all' || elType === currentType;
					const matchCategory = currentCategory === '__all' || elCategory === currentCategory;
					const matchTag = currentTag === '__all' || elTags.includes(currentTag);
					if (matchType && matchCategory && matchTag) {
						matched.push(el);
					} else {
						el.style.display = 'none';
					}
				});

				totalPages = Math.max(1, Math.ceil(matched.length / pageSize));
				if (currentPage > totalPages) currentPage = totalPages;

				matched.forEach((el, idx) => {
					const page = Math.floor(idx / pageSize) + 1;
					el.style.display = page === currentPage ? '' : 'none';
				});

				const show = totalPages > 1;
				if (paginationContainer) paginationContainer.style.display = show ? '' : 'none';

				pageNumberButtons.forEach((btn) => {
					const page = Number(btn.dataset.page || '1');
					btn.style.display = page <= totalPages ? '' : 'none';
					btn.classList.toggle('active', page === currentPage);
				});
			}

			function setPage(newPage) {
				if (newPage < 1) newPage = 1;
				if (newPage > totalPages) newPage = totalPages;
				currentPage = newPage;
				applyFilters();
			}

			tagButtons.forEach((btn) => {
				btn.addEventListener('click', () => {
					tagButtons.forEach((b) => b.classList.remove('active'));
					btn.classList.add('active');
					currentTag = btn.dataset.tag;
					setPage(1);
				});
			});

			categoryButtons.forEach((btn) => {
				btn.addEventListener('click', () => {
					categoryButtons.forEach((b) => b.classList.remove('active'));
					btn.classList.add('active');
					currentType = btn.dataset.type;
					currentCategory = btn.dataset.category;
					setPage(1);
				});
			});

			paginationButtons.forEach((btn) => {
				btn.addEventListener('click', () => {
					const val = btn.dataset.page;
					if (val === 'prev') {
						setPage(currentPage - 1);
						return;
					}
					if (val === 'next') {
						setPage(currentPage + 1);
						return;
					}
					setPage(Number(val || '1'));
				});
			});

			setPage(1);
		};

		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', initFilters, { once: true });
		} else {
			initFilters();
		}
	</script>
</BaseLayout>


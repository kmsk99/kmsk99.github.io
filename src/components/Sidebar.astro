---
import { getCollection } from 'astro:content';

interface Props {
	tagType?: 'all' | 'project' | 'post' | 'retro';
}

const { tagType = 'all' } = Astro.props as Props;

const labelFromFolder = (slug: string) => slug.replace(/-/g, ' ');
const asCategory = (entry: { id?: string }, fallback: string) => {
	const id = (entry as any).id || '';
	return id.split('/')[0] || fallback;
};

const projects = (await getCollection('projects')).sort(
	(a, b) => new Date(b.data.created).getTime() - new Date(a.data.created).getTime(),
);
const posts = (await getCollection('posts')).sort(
	(a, b) => new Date(b.data.created).getTime() - new Date(a.data.created).getTime(),
);
const retrospectives = (await getCollection('retrospectives')).sort(
	(a, b) => new Date(b.data.created).getTime() - new Date(a.data.created).getTime(),
);

const projectCategories = projects.reduce<Record<string, { count: number; label: string }>>((acc, p) => {
	const cat = asCategory(p, 'projects');
	if (!acc[cat]) acc[cat] = { count: 0, label: labelFromFolder(cat) };
	acc[cat].count += 1;
	return acc;
}, {});
const postCategories = posts.reduce<Record<string, { count: number; label: string }>>((acc, p) => {
	const cat = asCategory(p, 'posts');
	if (!acc[cat]) acc[cat] = { count: 0, label: labelFromFolder(cat) };
	acc[cat].count += 1;
	return acc;
}, {});
const retroCategories = retrospectives.reduce<Record<string, { count: number; label: string }>>((acc, r) => {
	const cat = asCategory(r, 'retrospectives');
	if (!acc[cat]) acc[cat] = { count: 0, label: labelFromFolder(cat) };
	acc[cat].count += 1;
	return acc;
}, {});

const projectTree = Object.entries(projectCategories).map(([key, info]) => ({
	title: info.label,
	slug: key,
	count: info.count,
}));
const postTree = Object.entries(postCategories).map(([key, info]) => ({
	title: info.label,
	slug: key,
	count: info.count,
}));
const retroTree = Object.entries(retroCategories).map(([key, info]) => ({
	title: info.label,
	slug: key,
	count: info.count,
}));

const filteredProjects = tagType === 'all' || tagType === 'project' ? projects : [];
const filteredPosts = tagType === 'all' || tagType === 'post' ? posts : [];
const filteredRetrospectives = tagType === 'all' || tagType === 'retro' ? retrospectives : [];
const tagSources = [...filteredProjects, ...filteredPosts, ...filteredRetrospectives];

const tags = tagSources.reduce<Record<string, number>>((acc, item) => {
	(item.data.tags ?? []).forEach((tag) => {
		acc[tag] = (acc[tag] ?? 0) + 1;
	});
	return acc;
}, {});
const sortedTags = Object.entries(tags).sort((a, b) => b[1] - a[1]);
const tagList = sortedTags.map(([value, count]) => ({ value, count }));
const totalCount = tagSources.length;
---

<aside class="sidebar">
	<section class="block compact">
		<p class="eyebrow">Categories</p>
		<ul class="tree">
			<li class="tree__section">
				<button class="tree__btn tree__section-btn" data-type="all" data-category="__all" data-nav="/">
					<span class="tree__folder">ğŸ—‚ï¸</span>
					<span class="tree__title">All ({projects.length + posts.length + retrospectives.length})</span>
				</button>
			</li>

			{projectTree.length > 0 && (
				<li class="tree__section">
					<button
						class="tree__btn tree__section-btn"
						data-type="project"
						data-category="__all"
						data-nav="/projects"
					>
						<span class="tree__folder">ğŸ› ï¸</span>
						<span class="tree__title">Projects ({projects.length})</span>
					</button>
					<ul class="tree tree__sub">
						{projectTree.map((item) => (
							<li>
								<button
									class="tree__btn"
									data-type="project"
									data-category={item.slug}
									data-nav="/projects"
								>
									<span class="tree__folder">ğŸ“</span>
									<span class="tree__title">
										{item.title}
										{item.count !== undefined ? ` (${item.count})` : ''}
									</span>
								</button>
							</li>
						))}
					</ul>
				</li>
			)}

			{postTree.length > 0 && (
				<li class="tree__section">
					<button class="tree__btn tree__section-btn" data-type="post" data-category="__all" data-nav="/posts">
						<span class="tree__folder">ğŸ“</span>
						<span class="tree__title">Posts ({posts.length})</span>
					</button>
					<ul class="tree tree__sub">
						{postTree.map((item) => (
							<li>
								<button class="tree__btn" data-type="post" data-category={item.slug} data-nav="/posts">
									<span class="tree__folder">ğŸ“</span>
									<span class="tree__title">
										{item.title}
										{item.count !== undefined ? ` (${item.count})` : ''}
									</span>
								</button>
							</li>
						))}
					</ul>
				</li>
			)}

			{retroTree.length > 0 && (
				<li class="tree__section">
					<button
						class="tree__btn tree__section-btn"
						data-type="retro"
						data-category="__all"
						data-nav="/retrospectives"
					>
						<span class="tree__folder">ğŸ”„</span>
						<span class="tree__title">Retrospectives ({retrospectives.length})</span>
					</button>
					<ul class="tree tree__sub">
						{retroTree.map((item) => (
							<li>
								<button class="tree__btn" data-type="retro" data-category={item.slug} data-nav="/retrospectives">
									<span class="tree__folder">ğŸ“</span>
									<span class="tree__title">
										{item.title}
										{item.count !== undefined ? ` (${item.count})` : ''}
									</span>
								</button>
							</li>
						))}
					</ul>
				</li>
			)}
		</ul>
	</section>

	<section class="block compact">
		<p class="eyebrow">Tags</p>
		<div class="tag-list" id="tag-list">
			<button class="tag-pill active" data-tag="__all">All ({totalCount})</button>
			{tagList.map((tag) => (
				<button class="tag-pill" data-tag={tag.value}>
					#{tag.value} ({tag.count})
				</button>
			))}
		</div>
	</section>
</aside>

<script is:inline>
	const navButtons = Array.from(document.querySelectorAll('.tree__btn'));

	navButtons.forEach((btn) => {
		const nav = btn.dataset.nav;
		const category = btn.dataset.category ?? '__all';
		const type = btn.dataset.type ?? 'all';

		if (!nav) return;

		btn.addEventListener('click', (e) => {
			e.preventDefault();
			const params = new URLSearchParams();
			params.set('category', category);
			params.set('type', type);
			const url = type === 'all' ? nav : `${nav}?${params.toString()}`;
			window.location.href = url;
		});
	});
</script>


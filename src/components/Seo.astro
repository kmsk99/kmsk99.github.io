---
import { SITE, absoluteUrl } from '../config/seo';

type StructuredData = Record<string, any> | Record<string, any>[];

interface Props {
	title?: string;
	description?: string;
	image?: string;
	type?: 'website' | 'article';
	canonical?: string;
	structuredData?: StructuredData;
	noindex?: boolean;
	publishedTime?: string;
	modifiedTime?: string;
	tags?: string[];
	locale?: string;
	siteName?: string;
}

const {
	title = SITE.title,
	description = SITE.description,
	image,
	type = 'website',
	canonical,
	structuredData,
	noindex = false,
	publishedTime,
	modifiedTime,
	tags = [],
	locale = SITE.locale,
	siteName = SITE.siteName,
} = Astro.props as Props;

const siteUrl = Astro.site ?? SITE.url;
const canonicalUrl =
	canonical ??
	(siteUrl ? new URL(`${Astro.url.pathname}${Astro.url.search}`, siteUrl).toString() : undefined);

const resolvedImage = absoluteUrl(image ?? SITE.defaultImage, siteUrl);
const robots = noindex ? 'noindex, nofollow' : 'index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1';
const isArticle = type === 'article';

const structuredArray = Array.isArray(structuredData)
	? structuredData.filter(Boolean)
	: structuredData
		? [structuredData]
		: [];

const hasWebSiteLd = structuredArray.some((item) => item?.['@type'] === 'WebSite');
if (!hasWebSiteLd && siteUrl) {
	structuredArray.unshift({
		'@context': 'https://schema.org',
		'@type': 'WebSite',
		url: siteUrl,
		name: SITE.title,
		description: SITE.description,
		inLanguage: 'ko',
	});
}
---

<title>{title}</title>
<meta name="description" content={description} />
<meta name="robots" content={robots} />
{canonicalUrl && <link rel="canonical" href={canonicalUrl} />}
{tags.length > 0 && <meta name="keywords" content={tags.join(', ')} />}
<meta name="author" content={SITE.author?.name ?? ''} />
<meta property="og:type" content={type} />
<meta property="og:title" content={title} />
<meta property="og:description" content={description} />
{canonicalUrl && <meta property="og:url" content={canonicalUrl} />}
{resolvedImage && <meta property="og:image" content={resolvedImage} />}
{resolvedImage && <meta property="og:image:alt" content={title} />}
{resolvedImage && <meta property="og:image:width" content="1200" />}
{resolvedImage && <meta property="og:image:height" content="630" />}
<meta property="og:site_name" content={siteName} />
<meta property="og:locale" content={locale} />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content={title} />
<meta name="twitter:description" content={description} />
{resolvedImage && <meta name="twitter:image" content={resolvedImage} />}
{resolvedImage && <meta name="twitter:image:alt" content={title} />}
{isArticle && publishedTime && <meta property="article:published_time" content={publishedTime} />}
{isArticle && (modifiedTime ?? publishedTime) && (
	<meta property="article:modified_time" content={modifiedTime ?? publishedTime} />
)}
{isArticle && SITE.author?.name && <meta property="article:author" content={SITE.author.name} />}
{isArticle &&
	tags?.map((tag) => <meta property="article:tag" content={tag} />)}

{structuredArray.map((data, idx) => (
	<script type="application/ld+json" set:html={JSON.stringify(data)} />
))}

